package vulnerability

import (
	"fmt"
	"time"

	"github.com/openctemio/api/pkg/domain/shared"
)

// FindingComment represents a comment on a finding.
type FindingComment struct {
	id             shared.ID
	findingID      shared.ID
	authorID       shared.ID
	authorName     string // Enriched from users table
	authorEmail    string // Enriched from users table
	content        string
	isStatusChange bool
	oldStatus      FindingStatus
	newStatus      FindingStatus
	createdAt      time.Time
	updatedAt      time.Time
}

// NewFindingComment creates a new comment.
func NewFindingComment(
	findingID shared.ID,
	authorID shared.ID,
	content string,
) (*FindingComment, error) {
	if findingID.IsZero() {
		return nil, fmt.Errorf("%w: finding id is required", shared.ErrValidation)
	}
	if authorID.IsZero() {
		return nil, fmt.Errorf("%w: author id is required", shared.ErrValidation)
	}
	if content == "" {
		return nil, fmt.Errorf("%w: content is required", shared.ErrValidation)
	}

	now := time.Now().UTC()
	return &FindingComment{
		id:             shared.NewID(),
		findingID:      findingID,
		authorID:       authorID,
		content:        content,
		isStatusChange: false,
		createdAt:      now,
		updatedAt:      now,
	}, nil
}

// NewStatusChangeComment creates a comment for a status change.
func NewStatusChangeComment(
	findingID shared.ID,
	authorID shared.ID,
	content string,
	oldStatus FindingStatus,
	newStatus FindingStatus,
) (*FindingComment, error) {
	comment, err := NewFindingComment(findingID, authorID, content)
	if err != nil {
		return nil, err
	}
	comment.isStatusChange = true
	comment.oldStatus = oldStatus
	comment.newStatus = newStatus
	return comment, nil
}

// ReconstituteFindingComment recreates a FindingComment from persistence.
func ReconstituteFindingComment(
	id shared.ID,
	findingID shared.ID,
	authorID shared.ID,
	authorName string,
	authorEmail string,
	content string,
	isStatusChange bool,
	oldStatus FindingStatus,
	newStatus FindingStatus,
	createdAt time.Time,
	updatedAt time.Time,
) *FindingComment {
	return &FindingComment{
		id:             id,
		findingID:      findingID,
		authorID:       authorID,
		authorName:     authorName,
		authorEmail:    authorEmail,
		content:        content,
		isStatusChange: isStatusChange,
		oldStatus:      oldStatus,
		newStatus:      newStatus,
		createdAt:      createdAt,
		updatedAt:      updatedAt,
	}
}

// Getters

func (c *FindingComment) ID() shared.ID            { return c.id }
func (c *FindingComment) FindingID() shared.ID     { return c.findingID }
func (c *FindingComment) AuthorID() shared.ID      { return c.authorID }
func (c *FindingComment) AuthorName() string       { return c.authorName }
func (c *FindingComment) AuthorEmail() string      { return c.authorEmail }
func (c *FindingComment) Content() string          { return c.content }
func (c *FindingComment) IsStatusChange() bool     { return c.isStatusChange }
func (c *FindingComment) OldStatus() FindingStatus { return c.oldStatus }
func (c *FindingComment) NewStatus() FindingStatus { return c.newStatus }
func (c *FindingComment) CreatedAt() time.Time     { return c.createdAt }
func (c *FindingComment) UpdatedAt() time.Time     { return c.updatedAt }

// Mutators

func (c *FindingComment) UpdateContent(content string) error {
	if content == "" {
		return fmt.Errorf("%w: content is required", shared.ErrValidation)
	}
	c.content = content
	c.updatedAt = time.Now().UTC()
	return nil
}
