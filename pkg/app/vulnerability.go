package app

import (
	"context"

	"github.com/openctemio/api/pkg/domain/shared"
	"github.com/openctemio/api/pkg/domain/vulnerability"
)

// CreateVulnerabilityInput represents the input for creating a vulnerability.
type CreateVulnerabilityInput struct {
	TenantID    string            `json:"tenant_id" validate:"required,uuid"`
	AssetID     string            `json:"asset_id" validate:"required,uuid"`
	Title       string            `json:"title" validate:"required,min=1,max=500"`
	Description string            `json:"description" validate:"max=10000"`
	Severity    string            `json:"severity" validate:"required,severity"`
	Source      string            `json:"source" validate:"required,max=255"`
	SourceRef   string            `json:"source_ref" validate:"max=255"`
	CVEID       string            `json:"cve_id" validate:"omitempty,cve"`
	CWEID       string            `json:"cwe_id" validate:"omitempty,cwe"`
	CVSSScore   *float64          `json:"cvss_score" validate:"omitempty,min=0,max=10"`
	Metadata    map[string]string `json:"metadata"`
}

// UpdateVulnerabilityInput represents the input for updating a vulnerability.
type UpdateVulnerabilityInput struct {
	TenantID string  `json:"tenant_id" validate:"required,uuid"`
	ID       string  `json:"id" validate:"required,uuid"`
	Status   *string `json:"status,omitempty" validate:"omitempty,finding_status"`
	Severity *string `json:"severity,omitempty" validate:"omitempty,severity"`
	Assignee *string `json:"assignee,omitempty" validate:"omitempty,uuid"`
	Notes    *string `json:"notes,omitempty" validate:"omitempty,max=5000"`
}

// ListVulnerabilitiesFilter represents filters for listing vulnerabilities.
type ListVulnerabilitiesFilter struct {
	TenantID   string   `json:"tenant_id"`
	AssetIDs   []string `json:"asset_ids"`
	Severity   []string `json:"severity"`
	Status     []string `json:"status"`
	Source     []string `json:"source"`
	CVEID      string   `json:"cve_id"`
	Search     string   `json:"search"`
	Page       int      `json:"page"`
	PerPage    int      `json:"per_page"`
	SortBy     string   `json:"sort_by"`
	SortOrder  string   `json:"sort_order"`
	DateFrom   string   `json:"date_from"`
	DateTo     string   `json:"date_to"`
	HasFixable *bool    `json:"has_fixable"`
}

// VulnerabilityService defines the interface for vulnerability operations.
type VulnerabilityService interface {
	// Create creates a new vulnerability.
	Create(ctx context.Context, input CreateVulnerabilityInput) (*vulnerability.Vulnerability, error)

	// Get retrieves a vulnerability by ID within a tenant.
	Get(ctx context.Context, tenantID, vulnID shared.ID) (*vulnerability.Vulnerability, error)

	// List returns paginated vulnerabilities matching the filter.
	List(ctx context.Context, filter ListVulnerabilitiesFilter) (*ListResult[*vulnerability.Vulnerability], error)

	// Update updates an existing vulnerability.
	Update(ctx context.Context, input UpdateVulnerabilityInput) (*vulnerability.Vulnerability, error)

	// Delete soft-deletes a vulnerability.
	Delete(ctx context.Context, tenantID, vulnID shared.ID) error

	// BulkUpdateStatus updates status for multiple vulnerabilities.
	BulkUpdateStatus(ctx context.Context, tenantID shared.ID, vulnIDs []shared.ID, status string) error

	// GetStatsByTenant returns vulnerability statistics for a tenant.
	GetStatsByTenant(ctx context.Context, tenantID shared.ID) (*VulnerabilityStats, error)

	// GetStatsByAsset returns vulnerability statistics for an asset.
	GetStatsByAsset(ctx context.Context, tenantID, assetID shared.ID) (*VulnerabilityStats, error)
}

// VulnerabilityStats represents vulnerability statistics.
type VulnerabilityStats struct {
	Total      int64            `json:"total"`
	BySeverity map[string]int64 `json:"by_severity"`
	ByStatus   map[string]int64 `json:"by_status"`
	BySource   map[string]int64 `json:"by_source"`
}
